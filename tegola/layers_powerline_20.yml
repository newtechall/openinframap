field_sets:
  geom_linestring:
    - name: geom
      sql: ST_AsMVTGeom(ST_SimplifyPreserveTopology(ST_MakeLine(ST_StartPoint(geometry),ST_EndPoint(geometry)), !PIXEL_WIDTH! / 4), !BBOX!)
    - name: is_node
      sql: (ST_GeometryType(geometry) = 'ST_Point')
  geom:
    - name: geom
      sql: ST_AsMVTGeom(ST_SimplifyPreserveTopology(geometry, !PIXEL_WIDTH! / 4), !BBOX!)
    - name: is_node
      sql: (ST_GeometryType(geometry) = 'ST_Point')
  geom_centroid:
    - name: geom
      sql: ST_AsMVTGeom(ST_Centroid(geometry), !BBOX!)
    - name: is_node
      sql: (ST_GeometryType(geometry) = 'ST_Point')
  frequency:
    - name: frequency
      sql: first_semi(tags -> 'frequency')
  area:
    - name: area
      sql: round(ST_Area(geometry))
  voltages:
    - name: voltage
      sql: convert_voltage(voltage) / 1000
    - name: voltage_2
      sql: convert_voltage(nth_semi(voltage, 2)) / 1000
    - name: voltage_3
      sql: convert_voltage(nth_semi(voltage, 3)) / 1000
  wiki:
    - name: wikidata
      sql: tags -> 'wikidata'
    - name: wikipedia
      sql: tags -> 'wikipedia'
  name:
    - name: name
      sql: tags -> 'name'
    - name: name_en
      sql: tags -> 'name:en'
    - name: name_es
      sql: tags -> 'name:es'
    - name: name_de
      sql: tags -> 'name:de'
    - name: name_fr
      sql: tags -> 'name:fr'
    - name: name_hi
      sql: tags -> 'name:hi'
    - name: name_ur
      sql: tags -> 'name:ur'
    - name: name_zh
      sql: tags -> 'name:zh'
    - name: name_ru
      sql: tags -> 'name:ru'
    - name: name_pt
      sql: tags -> 'name:pt'
    - name: name_ja
      sql: tags -> 'name:ja'
    - name: operator
      sql: tags -> 'operator'
    - name: ref
      sql: tags -> 'ref'
  construction:
    - name: construction
      sql: (tags -> 'construction:power') IS NOT NULL
  url:
    - name: url
      sql: osm_url(tags)
  source:
    - name: source
      sql: first_semi(source)
  output:
    - name: output
      sql: convert_power(output) / 1e6
  generator:
    - name: electrical_output
      sql: convert_power(tags -> 'generator:output:electricity')/1e6
    - name: method
      sql: tags -> 'generator:method'
    - name: type
      sql: tags -> 'generator:type'
    - name: plant_role
      sql: tags -> 'generator:plant'

  start_date:
    - name: start_date
      sql: tags->'start_date'

layers:
  - name: power_line
    geometry_type: LineString
    field_sets: [ geom_linestring, name, frequency, wiki, construction, start_date]
    id_field: osm_id
    fields:
      - name: tunnel
      - name: location
      - name: line
      - name: ref_len
        sql: char_length(tags -> 'ref')
      - name: voltage
        sql: voltages[1]
      - name: voltage_2
        sql: voltages[3]
      - name: voltage_3
        sql: voltages[3]
      - name: circuits
      - name: url
        sql: osm_url(tags)
    from: power_lines(!ZOOM!, !BBOX!)
    where: >
      ST_Length(geometry) > !PIXEL_WIDTH! / 4 AND convert_voltage(voltage) > 200000
    order_by: convert_voltage(voltage) ASC NULLS FIRST
